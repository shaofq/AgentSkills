





# 邮件派单系统功能总结

## 一、系统概述

**邮件派单系统**是 LowCode AI 平台的自动化组件，通过监听指定邮箱的收件，自动解析邮件内容并触发对应的 AI 工作流执行，实现**邮件驱动的智能派单**。

---

## 二、系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    前端配置界面                              │
│              EmailTriggerConfig.vue                         │
└─────────────────────────┬───────────────────────────────────┘
                          │ API 调用
┌─────────────────────────▼───────────────────────────────────┐
│                 API 路由层 (FastAPI)                        │
│                 email_trigger.py                            │
│  - 配置管理 /email/config                                   │
│  - 服务控制 /email/start, /email/stop                       │
│  - 连接测试 /email/test-connection                          │
│  - 手动拉取 /email/fetch                                    │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│              邮件监听服务 (核心服务层)                       │
│              email_listener.py                              │
│                                                             │
│  EmailListenerManager (管理器)                              │
│    └── EmailListener (监听器) × N                           │
│          - IMAP 连接管理                                    │
│          - 邮件拉取与解析                                   │
│          - 规则匹配                                         │
│          - 工作流触发                                       │
└─────────────────────────┬───────────────────────────────────┘
                          │ 触发回调
┌─────────────────────────▼───────────────────────────────────┐
│                工作流执行引擎                                │
│              execution.py                                   │
│  - 执行预定义工作流                                         │
│  - Agent 编排与调度                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## 三、核心功能模块

### 1. 📬 邮箱账户管理

| 功能 | 说明 |
|------|------|
| **多账户支持** | 可配置多个邮箱账户，独立监听 |
| **IMAP 协议** | 支持 IMAP/IMAP SSL 协议连接 |
| **安全配置** | 密码通过环境变量存储，不明文保存 |
| **连接测试** | 可测试邮箱连接，显示未读邮件数 |

**配置项**:
```json
{
  "id": "dispatch_inbox",
  "name": "派单邮箱",
  "email": "example@163.com",
  "imap_server": "imap.163.com",
  "imap_port": 993,
  "use_ssl": true,
  "username": "example@163.com",
  "password_env": "DISPATCH_EMAIL_PASSWORD"
}
```

---

### 2. 📧 邮件解析引擎

[EmailMessage](cci:2://file:///Users/shaoqiang/work/workspace/lowcodeUI/lowcode-ai/api/services/email_listener.py:18:0-74:3) 类完整解析邮件信息：

| 字段 | 说明 |
|------|------|
| `from_addr` / `from_name` | 发件人地址和名称 |
| `to_addr` | 收件人地址 |
| `subject` | 邮件主题 |
| `date` | 发送时间 |
| `body_text` | 纯文本正文 |
| `body_html` | HTML 正文 |
| `attachments` | 附件列表（文件名、类型、大小） |

**特性**:
- 自动解码多种字符集（UTF-8, GBK 等）
- HTML 转纯文本提取
- 多部件邮件（Multipart）解析
- 附件提取与元数据记录

---

### 3. 🔀 工作流绑定与规则匹配

每个邮箱账户可配置多个**工作流绑定规则**：

```json
{
  "workflow_bindings": [
    {
      "workflow_name": "auto_dispatch_flow",
      "conditions": {
        "allowed_senders": ["*@company.com", "vip@partner.com"],
        "subject_contains": ["订单", "派单"]
      },
      "default": true
    }
  ]
}
```

**匹配规则**:

| 条件 | 说明 |
|------|------|
| `allowed_senders` | 发件人白名单，支持通配符 `*`, `?` |
| `subject_contains` | 主题关键词匹配，任一匹配即可 |
| `default` | 是否作为默认工作流（无匹配时使用） |

**匹配逻辑**:
1. 遍历所有绑定规则
2. 检查发件人是否在白名单
3. 检查主题是否包含关键词
4. 返回首个匹配的工作流，或默认工作流

---

### 4. ⚡ 工作流触发

匹配成功后，系统自动将邮件内容格式化为工作流输入：

```
收到新邮件:
- 发件人: 张三 <zhangsan@company.com>
- 主题: 【派单申请】物流运输需求
- 时间: Mon, 06 Jan 2026 08:30:00 +0800
- 附件: 需求说明.pdf, 报价单.xlsx

邮件内容:
您好，我需要安排一批货物运输...
```

触发后调用 `run_predefined_workflow_internal()` 执行对应工作流。

---

### 5. 🔄 轮询与服务管理

| 功能 | 说明 |
|------|------|
| **定时轮询** | 默认 30 秒轮询一次，可配置 |
| **自动重连** | 连接断开自动重新建立 |
| **服务启停** | API 控制启动/停止监听服务 |
| **状态监控** | 实时查看各账户连接状态 |
| **手动拉取** | 支持手动触发邮件拉取 |

---

## 四、前端配置界面

`@/Users/shaoqiang/work/workspace/lowcodeUI/lowcode-ai/frontend/src/components/EmailTriggerConfig.vue` 提供可视化配置：

| 功能区 | 说明 |
|--------|------|
| **全局开关** | 启用/禁用邮件触发功能 |
| **轮询间隔** | 设置检查新邮件的时间间隔 |
| **服务状态** | 显示运行状态，提供启动/停止按钮 |
| **账户列表** | 添加、编辑、删除邮箱账户 |
| **连接测试** | 测试邮箱配置是否正确 |
| **工作流绑定** | 配置邮件匹配规则和目标工作流 |

---

## 五、API 接口列表

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/email/config` | GET | 获取邮件触发配置 |
| `/api/email/config` | POST | 保存邮件触发配置 |
| `/api/email/test-connection` | POST | 测试邮箱连接 |
| `/api/email/start` | POST | 启动监听服务 |
| `/api/email/stop` | POST | 停止监听服务 |
| `/api/email/status` | GET | 获取服务状态 |
| `/api/email/fetch` | POST | 手动拉取邮件 |
| `/api/email/history` | GET | 获取触发历史 |

---

## 六、典型使用场景

1. **客户订单自动派单** - 客户发送订单邮件，自动触发订单处理工作流
2. **服务请求自动响应** - 收到服务请求邮件，自动分配给相应智能体处理
3. **数据报表自动生成** - 定期邮件触发数据分析工作流，生成报表
4. **文档自动处理** - 收到带附件邮件，自动进行 OCR 识别和内容提取

---

## 七、配置文件

配置存储于 `@/Users/shaoqiang/work/workspace/lowcodeUI/lowcode-ai/config/email_triggers.json`:

```json
{
  "enabled": true,
  "poll_interval_seconds": 30,
  "email_accounts": [
    {
      "id": "dispatch_inbox",
      "name": "派单邮箱",
      "email": "shaofq5055240@163.com",
      "imap_server": "imap.163.com",
      "imap_port": 993,
      "use_ssl": true,
      "username": "shaofq5055240@163.com",
      "password_env": "DISPATCH_EMAIL_PASSWORD",
      "workflow_bindings": [
        {
          "workflow_name": "auto_dispatch_flow",
          "conditions": {
            "allowed_senders": ["*"],
            "subject_contains": []
          },
          "default": true
        }
      ]
    }
  ]
}
```

---

## 八、特色亮点

1. **无侵入式集成** - 通过邮件触发，无需修改原有业务系统
2. **灵活的规则引擎** - 支持多条件组合匹配
3. **多账户并行** - 同时监听多个邮箱
4. **可视化配置** - 无需编码即可配置派单规则
5. **与工作流深度整合** - 直接触发可视化编排的 AI 工作流